<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajax Demo</title>
    <style>
        button {
            width: 100px;
            height: 30;
            border: solid 1px #ccc;
            background-color: #aaeeff;
            border-radius: 5px;
        }

        div {
            width: 200px;
            height: 100px;
            padding: 5px 10px;
            border-radius: 5px;
            border: solid 3px #efefef;

            margin-top: 10px;
        }

        .notice {
            color: #c11;
        }
    </style>
</head>

<body>
    <h3>get 请求实践</h3>
    <button id="btn">获取请求</button>
    <div id="content"></div>
    <h3>post 请求实践</h3>
    <div id="hover"></div>
    <h3>响应体为 JSON 实践</h3>
    <div id="keydown"></div>
    <h3>请求超时实践</h3>
    <div id="timeout"></div>
    <h3>取消请求</h3>
    <p id="delay"><button id="send">发送请求</button> <button id="cancel">取消请求</button></p>
    <ul>
        <li>
            <p>客户端准备</p>
            <ol>
                <li>客户端画页面</li>
                <li>客户端事件绑定</li>
                <li>客户端封装 ajax 请求</li>
            </ol>
            <p>服务器端页面</p>
            <ol>
                <li>服务端页面初始化</li>
                <li>服务端安装 express</li>
                <li>服务端使用 express 完成服务器功能的编写</li>
            </ol>
        </li>
        <li>get 请求实践</li>
        <li>post 请求实践</li>
        <li>
            <p>post 请求 + 参数实践</p>
            <p>var params = 'name:admin&password:1234567'</p>
            <p>'name=admin&password=1234567'</p>
            <p>12345678</p>
        </li>
        <li>
            <p>请求头设置实践</p>
            <ol>
                <li>预定义请求头设置</li>
                <li>自定义请求头设置</li>
            </ol>
            <p class="notice">注意：服务端请求类型必须为 app.all() 接收任意类型请求，且需要设置响应头
                response.setHead('access-control-allow-headers','*')</p>
        </li>
        <li>
            <p>服务端响应体为 JSON 数据的，展示 JSON 的值到文本框，具体如下方法选其一：</p>
            <ol>
                <li>json.parse(xhr.response)</li>
                <li class="notice">xhr.open(method,url) 之前设置 xhr.responseType = 'json'</li>
            </ol>
        </li>
        <li>IE 浏览器 Ajax 缓存问题，具体方法是请求 url += 't=' + Date.now()</li>
        <li>请求超时或网络异常</li>
        <li>取消请求 xhr.abort()</li>
        <li>Ajax 重复发送请求</li>
    </ul>

    <script>
        var btn = document.getElementById('btn')
        var ct = document.getElementById('content')
        var hover = document.getElementById('hover')
        var kd = document.getElementById('keydown')
        var to = document.getElementById('timeout')
        var delay = document.getElementById('delay')
        var btns = delay.querySelectorAll('button')

        // get 请求实践
        btn.onclick = function () {
            ajax('GET', 'http://127.0.0.1:8080/server', function (responseText) {
                ct.innerHTML = responseText
            })
        }

        // post 请求实践
        // var params = 'name=admin&password=1234567';
        var params = 'name:admin&password:1234567';
        hover.addEventListener('mouseover', function () {
            ajax('POST', 'http://127.0.0.1:8080/serverPOST', function (responseText) {
                hover.innerHTML = responseText
            }, params)
        })

        // 响应体 json 请求实践
        window.onkeydown = function () {
            ajax('POST', 'http://127.0.0.1:8080/serverJSON', function (responseText) {
                kd.innerHTML = responseText
            }, params)
        }

        // 网络请求超时实践
        to.addEventListener('mouseover', function () {
            ajax('POST', 'http://127.0.0.1:8080/serverDelay', function (responseText) {
                kd.innerHTML = responseText
            })
        })

        // 发送请求
        var xhr = null, isPending = false
        btns[0].onclick = function () {
            if (isPending) xhr.abort() // 取消上一个请求，避免重复请求给服务器造成压力 ** 点击事件后马上判断是否有上一次请求是否正在发送 **
            xhr = new XMLHttpRequest()
            xhr.abort()
            isPending = true
            xhr.open('GET', 'http://127.0.0.1:8080/serverDelay')
            xhr.send()
            // 监听响应状态 处理响应结果
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    isPending = false
                }
            }
        }

        // 取消请求
        btns[1].onclick = function () {
            xhr.abort()
        }



        // ajax 请求封装
        function ajax(rMethod, url, callback, params = '') {
            // 1. 创建 ajax 对象
            var xhr = new XMLHttpRequest()
            xhr.responseType = 'json'
            // 2. 初始化 ajax方法和请求地址
            url += '?t=' + Date.now()
            xhr.open(rMethod, url)

            // == 设置请求头 start ==
            // xhr.setRequestHeader('content-type', 'application/x-www-form-urlencoded')
            xhr.setRequestHeader('name', 'mouses')
            // == 设置请求头 end ==

            // 设置请求超时时间
            xhr.timeout = 2000
            // 设置超时回调
            xhr.ontimeout = function () {
                alert('请求超时')
            }
            xhr.onerror = function () {
                alert('网络开小差了')
            }

            /**
             * 3. 发起 ajax 请求
             * 3.1 设置请求体
             */
            xhr.send(params)
            // 4. 处理响应结果
            xhr.onreadystatechange = function () {
                /**
                 * readyState
                 * 0 UNSENT 代理创建，但没有通过 open() 初始化请求
                 * 1 OPENED 代理初始化，但 send() 没有发送请求
                 * 2 HEADERS_RECEIVED 已接收到头部状态
                 * 3 LOADING 响应加载中
                 * 4 DONE 响应下载完成
                 * 
                 * =======
                 * state 请求状态码
                 * 200 请求成功
                 */

                if (xhr.readyState === 4) {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        callback(xhr.response.name)
                    }
                }
            }
        }
    </script>
</body>

</html>